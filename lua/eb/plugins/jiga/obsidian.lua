--        _         _     _ _
--   ___ | |__  ___(_) __| (_) __ _ _ __
--  / _ \| '_ \/ __| |/ _` | |/ _` | '_ \
-- | (_) | |_) \__ \ | (_| | | (_| | | | |
--  \___/|_.__/|___/_|\__,_|_|\__,_|_| |_|
-- https://github.com/epwalsh/obsidian.nvim

-- NOTE:
-- this plugin is not loaded at startup and would require manually loading

return {

    "epwalsh/obsidian.nvim",
    ft = "markdown",
    event = {
        "BufReadPre " .. vim.fn.expand("~") .. "Documents/the_vault/**.md",
        "BufNewFile " .. vim.fn.expand("~") .. "Documents/the_vault/**.md",
        "BufEnter " .. vim.fn.expand("~") .. "Documents/the_vault/**.md",
    },
    dependencies = {
        "nvim-lua/plenary.nvim",
    },

    config = function()
        local obsidian = require("obsidian")
        local custom_helpers = require("eb.utils.custom_helpers")
        local keymap_normal = custom_helpers.keymap_normal
        local keymap_visual = custom_helpers.keymap_visual

        -- NOTE: this function opens hyperlinks in web browsers
        local follow_url = function(url)
            vim.fn.jobstart({
                "xdg-open",
                url,
            })
        end

        -- NOTE: tihs function will rename a new note in obisidan based on whether a title was given or not
        local new_note_id = function(title)
            local suffix = ""
            if title ~= nil then
                suffix = title:gsub(" ", "-"):gsub("[^A-Za-z0-9-]", ""):lower()
            else
                -- NOTE: add randomization if no title is entered
                suffix = tostring(os.time()) .. string.char(math.random(65, 90)) .. "-" .. "notitle"
            end
            return suffix
        end

        -- SETUP
        obsidian.setup({
            dir = "~/Documents/the_vault/",
            daily_notes = {
                folder = "dailies",
            },
            follow_url_func = follow_url,
            disable_frontmatter = true, -- disables the autogenerated header when creating new files
            note_id_func = new_note_id,
            templates = {
                subdir = "templates",
                date_format = "%Y-%m-%d (%a)",
                time_format = "%H:%M",
            },
            completion = {
                nvim_cmp = true,
            },
        })

        -- NOTE: this is a temporary fix for treesitter highlight not being enabled by default in markdown files
        vim.api.nvim_create_autocmd(
            { "BufEnter", "BufWinEnter" },
            { pattern = { "*.md" }, command = "TSEnable highlight" }
        )

        keymap_normal("gf", ":ObsidianFollowLink<CR>", "OBSIDIAN", true, "follow Obsidian link")
        keymap_normal("<leader>oo", ":ObsidianOpen ", "OBSIDIAN", true, "Open note in Obsidian (optional args)")
        keymap_normal("<leader>on", ":ObsidianNew ", "OBSIDIAN", true, "Create new note in Obsidian (optional args)")
        keymap_normal(
            "<leader>of",
            ":ObsidianSearch ",
            "OBSIDIAN",
            true,
            "Search obsidian vault using ripgrep (optional args)"
        )
        keymap_normal(
            "<leader>ot",
            ":ObsidianTemplate<CR>",
            "OBSIDIAN",
            true,
            "Import from Obsidian template(optional args)"
        )
        keymap_normal("<leader>oq", ":ObsidianQuickSwitch<CR>", "OBSIDIAN", true, "Quickly switch between notes")
        keymap_normal("<leader>ob", ":ObsidianBacklinks<CR>", "OBSIDIAN", true, "Open Obsidian backlinks")
        keymap_normal("<leader>od", ":ObsidianToday<CR>", "OBSIDIAN", true, "Create new daily note")
        keymap_visual(
            "<leader>ol",
            ":ObsidianLink",
            "OBSIDIAN",
            true,
            "Link an inline visual selection to an existing note (optional args)"
        )
        keymap_visual(
            "<leader>Ol",
            ":ObsidianLinkNew",
            "OBSIDIAN",
            true,
            "Create a new note and link to a visual selection (optional args)"
        )

        -- TEST:
        -- print("Hello from lazy obsidian")
    end,
}
